<!DOCTYPE html>
<html lang="en">

<head>
   <!-- <meta charset="UTF-8"> -->
   <title>House Detection</title>
   <style>
      /* Global Styles */
      * {
         box-sizing: border-box;
      }

      html,
      body {
         margin: 0;
         padding: 0;
         font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
         background-color: #f7f7f7;
         color: #333;
      }

      body {
         display: flex;
         flex-direction: column;
         align-items: center;
         padding: 10px;
      }

      h1 {
         margin-bottom: 10px;
         font-size: 2rem;
         text-align: center;
         color: #444;
      }

      /* Container */
      .container {
         background: #fff;
         width: 100%;
         max-width: 1300px;
         margin: 10px auto;
         padding: 15px;
         border-radius: 8px;
         box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
         margin-bottom: 10px;
      }

      .container h2 {
         margin-top: 0;
      }

      /* List of added images */
      #imageListUI {
         list-style: none;
         padding: 0;
         margin: 0;
      }

      #imageListUI li {
         padding: 5px 10px;
         margin-bottom: 5px;
         background-color: #eee;
         border-radius: 4px;
      }

      /* Input Groups */
      .input-group {
         display: flex;
         flex-wrap: wrap;
         gap: 15px;
         margin-bottom: 15px;
      }

      .param-group {
         flex: 1 1 200px;
         display: flex;
         flex-direction: column;
      }

      .param-group label {
         margin-bottom: 5px;
         font-weight: 600;
      }

      .param-group input[type="number"],
      .param-group input[type="text"] {
         padding: 8px 10px;
         border: 1px solid #ccc;
         border-radius: 4px;
         transition: border-color 0.2s;
      }

      .param-group input[type="number"]:focus,
      .param-group input[type="text"]:focus {
         border-color: #4caf50;
      }

      /* Checkbox styling */
      .param-group input[type="checkbox"] {
         width: auto;
         margin-top: 8px;
      }

      /* Buttons */
      button {
         display: inline-block;
         width: 100%;
         padding: 12px 20px;
         margin-top: 15px;
         background-color: #4caf50;
         color: #fff;
         border: none;
         border-radius: 4px;
         font-size: 1rem;
         cursor: pointer;
         transition: background-color 0.3s;
      }

      button:hover {
         background-color: #45a049;
      }

      /* Result Text */
      #result {
         margin-top: 15px;
         font-size: 1.1rem;
         text-align: center;
      }

      /* Map UI Styles */
      .mapUi {
         width: 95%;
         height: 85vh;
         position: relative;
         margin-bottom: 30px;
         background: #e9e9e9;
         border-radius: 8px;
         overflow: hidden;
      }

      #mapContainer {
         width: 100%;
         height: 100%;
      }

      #mapContainer img {
         width: 100%;
         height: auto;
         object-fit: cover;
         display: block;
      }

      /* Map Controls Overlay */
      .controls {
         width: 80%;
         position: absolute;
         left: 10px;
         bottom: 10px;
         display: flex;
         justify-content: space-between;
         align-items: flex-start;
         /* Align items to the top */
         flex-wrap: wrap;
         /* Allow wrapping if the screen is narrow */
         padding: 10px;
         background: rgba(255, 255, 255, 0.95);
         border-radius: 8px;
         box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
         z-index: 1000;
         background-color: rgba(255, 255, 255, 0.436);
      }

      .controls>div {
         display: flex;
         flex-direction: column;
         /* Ensure each label-input pair is stacked */
         margin-right: 15px;
         /* Space between divs */
         width: 20%;
         /* You can adjust the width of each block */
      }

      .controls label {
         display: block;
         margin-bottom: 5px;
         font-size: 0.9rem;
         font-weight: 500;
      }

      .controls input,
      .controls button {
         width: 100%;
         margin-bottom: 10px;
         padding: 8px;
         border: 1px solid #ccc;
         border-radius: 4px;
      }

      .controls button {
         background-color: #4caf50;
         color: #fff;
         border: none;
         cursor: pointer;
         transition: background-color 0.3s;
      }

      .controls button:hover {
         background-color: #45a049;
      }

      /* Detection Results Layout */
      #resultsContainer {
         display: flex;
         flex-direction: column;
         gap: 20px;
      }

      .detection-result {
         border: 1px solid #ddd;
         border-radius: 4px;
         padding: 10px;
         background-color: #fafafa;
      }

      .detection-result h3 {
         margin-top: 0;
      }

      .images-wrapper {
         display: flex;
         gap: 20px;
         margin-top: 10px;
      }

      .images-wrapper img {
         width: 48%;
         border: 1px solid #ccc;
         border-radius: 4px;
      }

      /* Responsive Adjustments */
      @media (max-width: 768px) {
         .images-wrapper {
            flex-direction: column;
         }

         .images-wrapper img {
            width: 100%;
         }

         .controls {
            width: calc(100% - 20px);
            left: 50%;
            transform: translateX(-50%);
         }
      }
   </style>
   <!-- Include Chart.js for bar graph -->
   <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
   <h1>House Detection System</h1>

   <!-- MAP SECTION -->
   <div class="mapUi">
      <div id="mapContainer"></div>
      <div class="controls">
         <div>
            <label for="latLon">Latitude,Longitude:</label>
            <input type="text" id="latLon" placeholder="e.g. 24.642248, 94.098629">
         </div>
         <div>
            <label for="radius">Radius (km):</label>
            <input type="text" id="radius" placeholder="e.g. 1">
         </div>
         <div>
            <label for="zoom">Zoom:</label>
            <input type="text" id="zoom" placeholder="e.g. 15">
         </div>
         <div>
            <label for="scale">Scale:</label>
            <input type="text" id="scale" placeholder="e.g. 2">
         </div>
      </div>
   </div>

   <div class="container">
      <div class="input-group">
         <div class="param-group">
            <button onclick="getMap()">Get Map</button>
         </div>
         <div class="param-group">
            <button onclick="addMapImage()">Add Image</button>
         </div>
      </div>
   </div>

   <!-- LIST OF ADDED IMAGES -->
   <div class="container">
      <h2>List of Added Images</h2>
      <ul id="imageListUI"></ul>
   </div>

   <!-- DIRECT UPLOAD SECTION -->
   <div class="container">
      <h2>Or Upload Your Own Images</h2>
      <input type="file" id="imageUpload" accept="image/*">
      <input type="file" id="imageUploadMultiple" accept="image/*" multiple>
   </div>

   <!-- DETECTION SETTINGS & ACTION -->
   <div class="container">
      <div class="input-group">
         <div class="param-group">
            <label for="confInput">Confidence:</label>
            <input type="number" id="confInput" value="0.4" step="0.1" min="0" max="1">
         </div>

         <div class="param-group">
            <label for="iouInput">IoU:</label>
            <input type="number" id="iouInput" value="0.35" step="0.1" min="0" max="1">
         </div>

         <div class="param-group">
            <label for="imgszInput">Image Size:</label>
            <input type="number" id="imgszInput" value="640">
         </div>

         <div class="param-group">
            <label for="drawLabelInput">Draw Label:</label>
            <input type="checkbox" id="drawLabelInput" checked>
         </div>
      </div>
      <div class="input-group">
         <div class="param-group">
            <button onclick="uploadImage()">Detect House (Single Upload)</button>
         </div>
         <div class="param-group">
            <button onclick="uploadMultipleImages()">Detect Houses (Multiple Upload)</button>
         </div>
         <div class="param-group">
            <button onclick="runDetectionOnAllImages()">Detect Houses (Maps Multiple)</button>
         </div>
      </div>
      <div id="result"></div>
   </div>

   <!-- RESULTS & GRAPH -->
   <div class="container">
      <h2>Detection Results</h2>
      <h3>House Detection Chart</h3>
      <canvas id="myChart" width="400" height="200"></canvas>

      <h3>House Detected with annotated</h3>
      <!-- We'll populate results dynamically here -->
      <div id="resultsContainer"></div>
   </div>

   <!-- Google Maps API (update API key as needed) -->
   <script async defer
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCfB6DQNL8WrYegbR0Xga_T2JfXEovWGME&callback=initMap">
      </script>
   <script>
      // Global array to store multiple images (map or otherwise)
      let imagesList = [];

      // Initialize a Chart.js bar chart for detection results
      const ctx = document.getElementById('myChart')?.getContext('2d');
      let myChart = null;

      if (ctx) {
         myChart = new Chart(ctx, {
            type: 'bar',
            data: {
               labels: [],
               datasets: [{
                  label: 'Detected Houses',
                  data: [],
                  backgroundColor: 'rgba(75, 192, 192, 0.2)',
                  borderColor: 'rgba(75, 192, 192, 1)',
                  borderWidth: 1
               }]
            },
            options: {
               responsive: true,
               scales: {
                  y: {
                     beginAtZero: true,
                     title: {
                        display: true,
                        text: 'Number of Houses'
                     }
                  }
               }
            }
         });
      }

      // Utility to display original + annotated images side by side,
      // with a title showing detection count.
      function displayDetectionResult(name, original, annotated, count) {
         const container = document.createElement("div");
         container.classList.add("detection-result");

         // Title with image name + count
         const title = document.createElement("h3");
         title.textContent = `${name}: Detected ${count} houses`;
         container.appendChild(title);

         // Side-by-side images
         const imagesWrapper = document.createElement("div");
         imagesWrapper.classList.add("images-wrapper");

         const origImg = document.createElement("img");
         origImg.src = original;
         origImg.alt = "Original";
         imagesWrapper.appendChild(origImg);

         const annImg = document.createElement("img");
         annImg.src = annotated;
         annImg.alt = "Annotated";
         imagesWrapper.appendChild(annImg);

         container.appendChild(imagesWrapper);
         document.getElementById("resultsContainer").appendChild(container);
      }

      // 1) Initialize Google Maps (optional dynamic map)
      async function initMap() {
         const lat = 24.792901;
         const lng = 93.933870;

         const radius = 1;
         const zoom = 8;

         const deltaLat = radius / 111;
         const deltaLng = radius / (111 * Math.cos(lat * Math.PI / 180));
         const swLat = lat - deltaLat;
         const swLng = lng - deltaLng;
         const neLat = lat + deltaLat;
         const neLng = lng + deltaLng;
         const visibleParam = `visible=${swLat},${swLng}|${neLat},${neLng}`;

         const apiKey = "AIzaSyCfB6DQNL8WrYegbR0Xga_T2JfXEovWGME"; // Replace with your actual API key
         const zoomParam = zoom ? `&zoom=${zoom}` : "";

         const url = `https://maps.googleapis.com/maps/api/staticmap?center=${lat},${lng}${zoomParam}&${visibleParam}&size=600x400&scale=2&maptype=satellite&key=${apiKey}`;

         document.getElementById("mapContainer").innerHTML =
            `<img src="${url}" alt="Satellite Map" />`;
      }

      // 2) Build a static map URL from single lat,lon input
      function getMap() {
         const latLonInput = document.getElementById("latLon").value;
         const [latStr, lonStr] = latLonInput.split(",").map(item => item.trim());
         const lat = parseFloat(latStr);
         const lng = parseFloat(lonStr);

         const radius = parseFloat(document.getElementById("radius").value);
         const zoom = document.getElementById("zoom").value;
         const scale = document.getElementById("scale").value;

         if (isNaN(lat) || isNaN(lng) || isNaN(radius)) {
            alert("Please enter valid lat,lon (e.g. 24.642248, 94.098629) and radius.");
            return;
         }

         const deltaLat = radius / 111;
         const deltaLng = radius / (111 * Math.cos(lat * Math.PI / 180));
         const swLat = lat - deltaLat;
         const swLng = lng - deltaLng;
         const neLat = lat + deltaLat;
         const neLng = lng + deltaLng;
         const visibleParam = `visible=${swLat},${swLng}|${neLat},${neLng}`;

         const apiKey = "AIzaSyCfB6DQNL8WrYegbR0Xga_T2JfXEovWGME"; // Replace with your actual API key
         const zoomParam = zoom ? `&zoom=${zoom}` : "";
         const scaleParam = scale ? `&scale=${scale}` : "";

         const url = `https://maps.googleapis.com/maps/api/staticmap?center=${lat},${lng}${zoomParam}${scaleParam}&${visibleParam}&size=600x400&maptype=satellite&key=${apiKey}`;

         document.getElementById("mapContainer").innerHTML =
            `<img src="${url}" alt="Satellite Map" />`;
      }

      // 3) Add the current map image to imagesList + UI list
      function addMapImage() {
         const mapImg = document.querySelector("#mapContainer img");
         if (!mapImg || !mapImg.src) {
            alert("Map image not found. Click 'Get Map' first.");
            return;
         }
         const name = "Map Image " + (imagesList.length + 1);
         imagesList.push({ name, src: mapImg.src });

         const li = document.createElement("li");
         li.textContent = name;
         document.getElementById("imageListUI").appendChild(li);

         alert(`Added "${name}" to the image list.`);
      }

      // 4) Upload a single file for detection
      function uploadImage() {
         const input = document.getElementById('imageUpload');
         if (input.files.length === 0) {
            alert('Please select an image file.');
            return;
         }

         const file = input.files[0];
         document.getElementById('result').innerText = 'Detecting houses, please wait...';

         const reader = new FileReader();
         reader.onload = function (e) {
            detectHouseFromFile(file);
         };
         reader.readAsDataURL(file);
      }

      // 5) Send a file (or Blob) to the backend for detection using a relative URL
      function detectHouseFromFile(fileObj, nameOverride = null) {
         const formData = new FormData();
         formData.append('file', fileObj);

         const conf = document.getElementById('confInput').value;
         const iou = document.getElementById('iouInput').value;
         const imgsz = document.getElementById('imgszInput').value;
         const draw_label = document.getElementById('drawLabelInput').checked;

         formData.append('conf', conf);
         formData.append('iou', iou);
         formData.append('imgsz', imgsz);
         formData.append('draw_label', draw_label);

         const fileName = nameOverride || fileObj.name || "Uploaded Image";

         fetch('/predict', {
            method: 'POST',
            body: formData
         })
            .then(response => response.json())
            .then(data => {
               if (data.error) {
                  document.getElementById('result').innerText = data.error;
               } else {
                  const count = data.predictions;
                  document.getElementById('result').innerText = `Detected ${count} houses in ${fileName}`;
                  displayDetectionResult(fileName, data.original_image, data.annotated_image, count);
                  if (myChart) {
                     myChart.data.labels.push(fileName);
                     myChart.data.datasets[0].data.push(count);
                     myChart.update();
                  }
               }
            })
            .catch(error => {
               console.error('Error:', error);
               document.getElementById('result').innerText = 'An error occurred. Please try again.';
            });
      }

      // 6) Fetch an image URL as a Blob
      function fetchImageFromURL(imageUrl) {
         return fetch(imageUrl)
            .then(response => response.blob())
            .catch(error => {
               console.error("Error fetching image:", error);
               return null;
            });
      }

      // 7) Detect houses from an image URL
      async function detectHouseFromURL(imageUrl, name) {
         const blob = await fetchImageFromURL(imageUrl);
         if (!blob) return 0;

         return new Promise((resolve) => {
            detectHouseFromFile(blob, name);
            setTimeout(() => {
               resolve(0);
            }, 1000);
         });
      }

      // 8) Run detection on all images in imagesList
      async function runDetectionOnAllImages() {
         if (imagesList.length === 0) {
            alert("No images in the list. Add images first.");
            return;
         }

         document.getElementById('result').innerText = 'Detecting houses for all images, please wait...';

         if (myChart) {
            myChart.data.labels = [];
            myChart.data.datasets[0].data = [];
            myChart.update();
         }

         document.getElementById("resultsContainer").innerHTML = "";

         for (let i = 0; i < imagesList.length; i++) {
            const { name, src } = imagesList[i];
            await detectHouseFromURL(src, name);
         }

         document.getElementById('result').innerText = 'Detection completed for all images.';
      }

      // 9) Upload multiple files for detection using a relative URL
      function uploadMultipleImages() {
         const input = document.getElementById('imageUploadMultiple');
         if (input.files.length === 0) {
            alert('Please select at least one image file.');
            return;
         }

         document.getElementById('result').innerText = 'Detecting houses, please wait...';

         const formData = new FormData();
         for (let i = 0; i < input.files.length; i++) {
            formData.append('files', input.files[i]);
         }

         const conf = document.getElementById('confInput').value;
         const iou = document.getElementById('iouInput').value;
         const imgsz = document.getElementById('imgszInput').value;
         const draw_label = document.getElementById('drawLabelInput').checked;

         formData.append('conf', conf);
         formData.append('iou', iou);
         formData.append('imgsz', imgsz);
         formData.append('draw_label', draw_label);

         fetch('/predict_multiple', {
            method: 'POST',
            body: formData
         })
            .then(response => response.json())
            .then(data => {
               if (data.error) {
                  document.getElementById('result').innerText = data.error;
               } else {
                  document.getElementById('result').innerText = 'Detection completed for selected images.';
                  data.results.forEach(item => {
                     if (item.error) {
                        alert(`Error for ${item.filename}: ${item.error}`);
                     } else {
                        displayDetectionResult(item.filename, item.original_image, item.annotated_image, item.predictions);
                        if (myChart) {
                           myChart.data.labels.push(item.filename);
                           myChart.data.datasets[0].data.push(item.predictions);
                           myChart.update();
                        }
                     }
                  });
               }
            })
            .catch(error => {
               console.error('Error:', error);
               document.getElementById('result').innerText = 'An error occurred. Please try again.';
            });
      }

   </script>
</body>

</html>